<div style="width:100%; height: 300px;overflow: hidden; background: url(https://picsum.photos/id/<%= i %>/1500/600); background-repeat: no-repeat; background-size: 100%;"></div>

<% 
var stringToColour = function(str) {
    var hash = 0;
    for (var i = 0; i < str.length; i++) {
      hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    var colour = '#';
    for (var i = 0; i < 3; i++) {
      var value = (hash >> (i * 8)) & 0xCF;
      colour += ('00' + value.toString(16)).substr(-2);
    }
    return colour;
  }
  %>

<% if (coconut.hhidden == "false" || (currentUser && currentUser.isAdmin)) { %>
    <div class="container mt-5">
        <h1 class="mb-4 display-3"><%= coconut.title %></h1>
        <div style="text-align: center;">
            <% if (coconut.technologies) { %>
                <% for (i=0; i<coconut.technologies.length; i++) { %>
                    <% let colo = stringToColour(coconut.technologies[i]) %>
                    <span class="text-light p-2 m-2 rounded" style="display:inline-block;background-color: <%= colo %>"><%= coconut.technologies[i].replace("_", " ") %></span>
                <% } %>
            <% } %>
        </div>
        <div class="row mt-4">
            <div class="col-md-9 pr-5">
                <h3 class="font-weight-lighter"><%= coconut.headline %></h3>
                <p class="font-weight-bolder mb-4"><%= coconut.llocation %></p>
                
                <% if (coconut.video) { %>
                    <iframe width=100% class="mb-4" src="<%= coconut.video %>"></iframe>
                <% } %>

                <p><%= coconut.situation %></p>
                <p><%= coconut.task %></p>
                <p><%= coconut.aaction %></p>
                <p><%= coconut.rresult %></p>

            </div>
            <div class="col-md-3 py-4 px-4 border rounded">
                <div>
                    <h3>Information</h3>
                </div>
                <p><b>Started: </b> <%= coconut.startDateString %></p>
                <p><b>Finished: </b> <%= coconut.endDateString %></p>
                <p><b>Time to Complete:</b> <%= coconut.ttime %> hours</p>
                <p><b>Project Type:</b> <%= coconut.ttype %> </p>
                <p><b>Project Class:</b> <%= coconut.category %></p>
                <p><b>Role:</b> <%= coconut.rrole %></p>

                <a class="btn btn-large btn-primary btn-block" target="_blank" href="<%= coconut.uurl %>">Go to project</a>
                <% if (currentUser && currentUser.isAdmin) { %>
                        <a class="btn btn-success btn-block" href="<%= urlPrefix %>/coconuts/<%= coconut._id %>/edit">Edit</a>    
                        <a class="btn btn-danger btn-block" href="<%= urlPrefix %>/coconuts/<%= coconut._id %>/delete" onclick="return confirm('Are you sure you want to remove this coconut?')">Remove</a>
                <% } %>

                    <label for="files" class="mt-3">Add File</label>
                    <input type="file" name="file" id="file">
                    <p id="uploadMessage"></p>
            
            </div>
        </div>
        <% if (coconut.files) { %>
        <h1 class="mb-3 display-4">Additional Resources</h1>
        <div class="row">
            <% coconut.files.forEach(obj => { %>
                <div class="col-md-2 my-3">
                        <% let ext = obj.split(".").pop().toLowerCase() %>

                        <!-- If the object is an image -->
                        <% if (ext == "jpg" || ext == "png" || ext == "gif" || ext == "jpeg") { %>
                        <div class="card my-3" style="width:100%;height:100%;">
                            <img class="card-img-top" src="https://<%= awsBucket %>.s3.amazonaws.com/<%= obj %>" alt="picture" style="width:100%; height:70px; object-fit: cover;">
                            <div class="card-body">
                                <small class="text-secondary mb-3"><%= obj %></small>
                                
                                <a href="https://<%= awsBucket %>.s3.amazonaws.com/<%= obj %>" download><small style="float:right"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg></small></a>
                            </div>
                        </div>
                        <!-- If the object is a pdf -->
                        <% } else if (ext == "pdf") { %>
                        <a href="https://<%= awsBucket %>.s3.amazonaws.com/<%= obj %>" target="_blank" style="text-decoration: none;">
                            <div class="card my-3" style="width:100%;height:100%;">
                                <div style="width: 100%; height: 70px;background-color: <%= stringToColour(obj) %>;"></div>
                                <div class="card-body">
                                    <small class="text-secondary mb-3"><%= obj %></small>
                                    
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                    </svg></small>
                                </div>
                            </div>
                        </a>
                        <% } %>
                </div>
            <% }); %>
            <% } %> 

        </div>
    </div>
    <% } else { %>
        <div class="container mt-3">
            <h2>This project is hidden.</h2>
        </div>
    <% } %>

        <!-- modal -->
        <div id="picture-modal" style="display: none; justify-content: center; align-items: center; height: 70vh; width:100vw; position:fixed; background-color: rgba(0, 0, 0, 0.5);z-index: 9999999; top: 5vh;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
            <p id="picture-exit" style="cursor:pointer;font-size: large;position:absolute;right:4vw;top:3vh;color:rgba(230, 226, 226, 0.89)">X</p>
            <img id="picture" src="" style="height: 90%;">
        </div>

    <script>
        document.querySelectorAll("div .card").forEach(card => {
            card.addEventListener("click", function(e) {
                let src = $(this).find("img")[0].src;
                let re = new RegExp('(https).*');
                let newSrc = re.exec(src)[0];
                document.querySelector("#picture").src = newSrc;
                document.querySelector("#picture-modal").style.display = "flex";

            })
        });

        document.querySelector("#picture-exit").addEventListener("click", function() {
            document.querySelector("#picture-modal").style.display = "none";
        });

        $("#newFileButton").on("click", function() {
          var input = $("#files-1").clone();

          fileNo += 1;
          input.id = "files-" + fileNo;

          $("input[type=file]:last").after(input);
      });

      $("#file").on("input", function(e) {
          let data = new FormData();
          let fileName = this['files'][0].name;
          data.append(fileName, this['files'][0]);
          
          $.post({
              url: "<%= urlPrefix %>/uploadS3",
              data: data,
              cache: false,
              contentType: false,
              processData: false,
              beforeSend: () => {
                let progressBar = document.createElement("progress");
                progressBar.setAttribute("id", "progressBar");
                this.parentNode.insertBefore(progressBar, this.nextSibling);
              },
              success: response => {
                  console.log("Success response");
                  console.log(response);
                  let progressBar = $("#progressBar");
                  let uploadMessage = $("#uploadMessage");
                  if (response.status == "success") {
                      uploadMessage.html("Upload successful");
                      progressBar.val(100);


                      addFileToProject($("#file").val().split(/(\\|\/)/g).pop());
                  } else if (response.status == "error") {
                      uploadMessage.html("There was an error uploading the file");
                      progressBar.val(0);
                  }
              },
              error: err => {
                  console.log("error response");
                console.log(err);
              },
              complete: () => {
                  window.setTimeout(() => {
                    $("#file").val("");
                    $("#progressBar").remove();
                    $("#uploadMessage").html("");
                  }, 3500);
              }
          });
      });

      function addFileToProject(fileName) {
        $.get({
            url: "<%= urlPrefix %>/api/g/coconuts/<%= coconut._id %>",
            success: (data) => {
                if (!data.files) { data.files = []}
                data.files.push(fileName);
                $.post({
                    url: "<%= urlPrefix %>/api/u/coconuts",
                    data: data,
                    success: (response) => {
                        console.log(response.message);
                    }
                })
            }
        });
      }

    </script>